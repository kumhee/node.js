<div class="row my-5">
    <div class="contents_title">
        <h1 class="text-center mb-5 title" >ë„ì„œëª©ë¡</h1>
    </div>

    <div class="mb-5">
        <div class="row mb-3">
            <form name="frm" class="col-md-4">
                <div class="input-group">
                    <select name="key" class="form-select me-2">
                        <option value="title">ì œëª©</option>
                        <option value="authors">ì €ì</option>
                        <option value="publisher">ì¶œíŒì‚¬</option>
                        <option value="contents">ë‚´ìš©</option>
                    </select>
                    <input name="query" class="form-control" placeholder="ê²€ìƒ‰ì–´">
                    <button class="btn btn-outline-secondary">ê²€ìƒ‰</button>
                </div>
            </form>
            <div class="mb-3 list_total_count text-end">ì „ì²´ ë„ì„œìˆ˜: <span id="total"></span></div>    
        </div>
        <div id="div_books"></div> 
        <div id="pagination" class="pagination justify-content-center mt-5"></div>
    </div>
</div><!--row-->

<!-- ë„ì„œëª©ë¡ í…œí”Œë¦¿ -->
<script id="temp_books" type="x-handlebars-template">
    <table class="table">
        <thead class="thead_list">
            <tr>
              <th width="2%"><input type="checkbox" name="" id="all"></th>
              <th width="5%">Img</th>
              <th width="5%">0</th>
              <th width="30%">Title</th>
              <th width="8%">Authors</th>
              <th width="40%">Contents</th>
              <th width="8%">Price</th>
              <th></th>
            </tr>
        </thead>
        <tbody class="table-group-divider tbody_list">
            {{#each .}}
                <tr>
                    <td><input type="checkbox" name="" class="chk" bid={{bid}}></td>
                    <td> <img src="{{isImage image}}" width="30px"></td>
                    <td>{{bid}}</td>
                    <td><div class="ellipsis"><a href="/books/read?bid={{bid}}">{{title}}</a></div></td>
                    <td><div class="ellipsis">{{authors}}</div></td>
                    <td><div class="ellipsis">{{contents}}</div></td>
                    <td>{{fmtPrice price}}</td>
                    <td><button bid = "{{bid}}" class="btn btn-outline-secondary btn-sm" id="btn_cart">ğŸ›’</button></td>
                    <td><button bid = "{{bid}}" class="btn btn-dark btn-sm btn_delete">âœ•</button></td>
                </tr>
            {{/each}}
        </tbody>
    </table>
    <div class="checkbox_btn">
        <a type="button" class="btn btn-outline-secondary btn-sm">ğŸ›’</a>
        <a type="button" class="sel_delete btn btn-dark btn-sm" id="delete">ì„ íƒì‚­ì œ</a>
    </div>
</script>

<script>
    Handlebars.registerHelper("isImage", function(image){
        if(image) {
            return image;
        } else {
            return "http://via.placeholder.com/170x230";
        }
    });

    Handlebars.registerHelper("fmtPrice", function(price){
        return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "ì›"
    });
</script>

<script>
    let page=1;
    getTotal();

    //í¼ì´ ì„œë°‹ì¸ ê²½ìš°
    $(frm).on("submit", function(e){
        e.preventDefault();
        page = 1;
        getTotal();
    });

    // ì„ íƒì‚­ì œ ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš°
    $("#div_books").on("click",".sel_delete",function(){
        const chk = $("#div_books .chk:checked").length;
        if(chk == 0) {
            alert("ì‚­ì œí•  ë„ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }
        if(!confirm(`${chk}ê°œì˜ ë„ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;  
        $("#div_books .chk:checked").each(function(){
            const bid = $(this).attr("bid");
            $.ajax({
                type: "post",
                url: "/books/delete",
                data: {bid},
                success: function(){
                    getTotal();
                }
            });
        });
    });

    // ì „ì²´ì„ íƒ ì‚­ì œë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš°
    $("#div_books").on("click","#all",function(){
        if($(this).is(":checked")){
            $("#div_books .chk").prop("checked", true);
        } else {
            $("#div_books .chk").prop("checked", false);
        }
    });

    // ê° í–‰ì˜ ì²´í¬ë°•ìŠ¤ë¥¼ í´ë¦­í•œ ê²½ìš°(ì „ì²´ì„ íƒëœ ì²´í¬ í•´ì œ)
    $("#div_books").on("click",".chk",function(){
        const all = $("#div_books .chk").length;
        const chk = $("#div_books .chk:checked").length;
        if(all == chk) {
            $("#div_books #all").prop("checked", true);
        } else {
            $("#div_books #all").prop("checked", false);
        }
    });

    // ê° í–‰ì˜ ì‚­ì œë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš°
    $("#div_books").on("click",".btn_delete",function(){
        const bid=$(this).attr("bid");
        if(!confirm(bid + "ë²ˆ ë„ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        $.ajax({
            type:"post",
            url:"/books/delete",
            data:{bid:bid},
            success:function(){
                alert("ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                getTotal(); //ì‚­ì œ í›„ ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            }
    })
});


function getTotal(){
    const key=$(frm.key).val();
    const query=$(frm.query).val();
    $.ajax({
        type:"get",
        url:"/books/count",
        data:{key, query},
        success:function(data){
            $("#total").html(data.total + "ê¶Œ");
            if(data.total > 0) {
                const totalPages = Math.ceil(data.total/5);
                $("#pagination").twbsPagination("changeTotalPages", totalPages, page)
            } else {
                alert("ê²€ìƒ‰ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
                $(frm.query).val("");
                getTotal();
            }
            
        }
    });
}

function getBooks(){
    const key=$(frm.key).val();
    const query=$(frm.query).val();
    //alert(key+query);
    $.ajax({
        type:"get",
        url:"/books/list.json",
        data:{page, key, query},
        success:function(data){
            //console.log(data);
            const temp=Handlebars.compile($("#temp_books").html());
            $("#div_books").html(temp(data));
            const totalPages=20;
        }
    });
}

    $('#pagination').twbsPagination({
        totalPages:10, //ì´ í˜ì´ì§€ ë²ˆí˜¸ ìˆ˜
        visiblePages: 5, // í•˜ë‹¨ì—ì„œ í•œ ë²ˆì— ë³´ì—¬ ì§€ëŠ” í˜ì´ì§€ ë²ˆí˜¸ ìˆ˜
        startPage : 1, // ì‹œì‘ ì‹œ í‘œì‹œë˜ëŠ” í˜„ì¬ í˜ì´ì§€
        initiateStartPageClick: false, // í”ŒëŸ¬ê·¸ì¸ì´ ì‹œì‘ ì‹œ í˜ì´ì§€ ë²„íŠ¼ í´ë¦­ ì—¬ë¶€ (default : true) 
        first : '<i class="bi bi-chevron-double-left"></i>', // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ì¤‘ ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ëŠ” ë²„íŠ¼ì— ì“°ì—¬ ìˆëŠ” í…ìŠ¤íŠ¸
        prev : '<i class="bi bi-chevron-left"></i>', // ì´ì „ í˜ì´ì§€ ë²„íŠ¼ì— ì“°ì—¬ ìˆëŠ” í…ìŠ¤íŠ¸
        next : '<i class="bi bi-chevron-right"></i>', // ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ì— ì“°ì—¬ ìˆëŠ” í…ìŠ¤íŠ¸
        last : '<i class="bi bi-chevron-double-right"></i>', // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ì¤‘ ë§ˆì§€ë§‰ìœ¼ë¡œ ê°€ëŠ” ë²„íŠ¼ì— ì“°ì—¬ ìˆëŠ” í…ìŠ¤íŠ¸
        onPageClick: function (event, clickPage) {
            page = clickPage; 
            getBooks(); 
        }
    });
</script>